name: Update Energy Analytics

on:
  schedule:
    # Run daily at 12:00 PM UTC (10:00 PM Eastern Australian Time)
    - cron: '0 12 * * *'
  workflow_dispatch:  # Allow manual trigger
  push:
    branches: [ main ]

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - name: ğŸ§­ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: âš¡ Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸ—‚ï¸ Create directories
      run: |
        mkdir -p App/Data
        mkdir -p docs
        echo "ğŸ“ Directory structure ready"

    - name: ğŸ” Set environment variables
      run: |
        echo "OPENELECTRICITY_API_KEY=${{ secrets.OPENELECTRICITY_API_KEY }}" >> $GITHUB_ENV
        echo "GITHUB_ACTIONS=true" >> $GITHUB_ENV
        if [ -n "${{ secrets.OPENELECTRICITY_API_KEY }}" ]; then
          echo "âœ… API key secret available"
        else
          echo "âŒ API key secret missing"; exit 1;
        fi

    - name: ğŸš€ Run analytics update
      env:
        OPENELECTRICITY_API_KEY: ${{ secrets.OPENELECTRICITY_API_KEY }}
      run: |
        echo "ğŸ” Checking App/src/"
        ls -la App/src/ || echo "App/src/ not found"
        cd App/src
        echo "ğŸš€ Running analytics script..."
        python app.py || { echo "âŒ app.py execution failed"; exit 1; }
        cd ../../
        echo "âœ… Analytics completed"
        ls -la docs/ || echo "âŒ docs folder not found"

    - name: âœ… Verify generated output
      run: |
        if [ ! -d "docs" ] || [ -z "$(ls -A docs 2>/dev/null)" ]; then
          echo "âŒ No files generated in docs/"
          exit 1
        else
          echo "âœ… Files successfully generated:"
          ls -la docs/
        fi

    - name: ğŸ’¾ Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Pull any remote changes first
        git pull origin main --rebase || echo "No remote changes to pull"
        
        # Add files and directories that exist
        [ -d "App/Data" ] && git add App/Data/ || echo "App/Data/ not found"
        [ -d "docs" ] && git add docs/ || echo "docs/ not found"
        
        if git diff --staged --quiet; then
          echo "ğŸ“ No changes to commit"
        else
          git commit -m "ğŸ¤– Auto-update: Energy analytics $(date '+%Y-%m-%d %H:%M:%S UTC')"
          git push origin main
          echo "âœ… Changes committed and pushed"
        fi

    - name: ğŸ“¤ Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: docs/

    - name: ğŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
